<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8">
		<title>图书管理</title>
		<link rel="stylesheet" href="../../layuiadmin/layui/css/layui.css" media="all">
		<script src="../../layuiadmin/js/jquery.min.js" type="text/javascript" charset="utf-8"></script>
		<script src="../../layuiadmin/js/getCookie.js" type="text/javascript" charset="utf-8"></script>
		<script src="../../layuiadmin/js/vue.min.js" type="text/javascript" charset="utf-8"></script>
		<script src="../../layuiadmin/js/Tools.js" type="text/javascript" charset="utf-8"></script>
	</head>
	<body>
		<div class="layui-fluid">
			<div class="layui-card" style="padding: 10px 20px 20px 20px;margin-top: 20px;">
				<div class="layui-form" style="margin-top: 30px;">
					<div class="layui-form-item">
						<div class="layui-input-inline" style="width: 200px;">
							<input type="text" name="searchName" lay-verify="title" autocomplete="off" placeholder="请输书名进行搜索"
							 class="layui-input">
						</div>
						<div class="layui-inline">
							<div class="layui-input-inline">
								<input name="searchAuthor" type="text" autocomplete="off" class="layui-input" placeholder="作者">
							</div>
						</div>
						<div class="layui-inline" id="search">
							<div class="layui-input-inline" style="margin-right: -10px;">
								<select name="searchPress">
									<option value="">请选择出版社</option>
									<option :value="item.id" v-for="item in list">{{item.name}}</option>
								</select>
							</div>
						</div>
						<div class="layui-inline">
							<div class="layui-input-inline">
								<input name="searchPushTime" type="text" autocomplete="off" class="layui-input" id="laydate1" placeholder="出版时间">
							</div>
						</div>
						<div class="layui-inline">
							<button class="layui-btn" lay-submit lay-filter="search">
								<i class="layui-icon layui-icon-search"></i>搜索
							</button>
						</div>
					</div>
					<div class="layui-form-item">
						<table class="layui-table" id="table" lay-filter="table"></table>
						<script type="text/html" id="btns">
							<div class="layui-btn layui-btn-xs" lay-event="xq">
								详情
							</div>
							<div class="layui-btn layui-btn-xs layui-btn-normal" lay-event="js">
								借书
							</div>
						</script>
					</div>
				</div>
			</div>
		</div>
	</body>
	<script src="../../layuiadmin/layui/layui.js"></script>
	<script>
		var vue = new Vue({
			el:'#search',
			data:{
				list:[],
				types:[],
				form:null
			},
			created:function(){
				$.get("http://localhost:8088/book/press/",function(res){
					vue.list = res.data
				})
				$.get("http://localhost:8088/book/types/",function(res){
					vue.types = res.data
				})
			},
			updated:function(){
				if(vue.form!=null){
					vue.form.render()
				}
			}
		})
		
		layui.use(['laydate', 'form', 'table'], function() {
			var form = layui.form;
			vue.form = form
			var laydate = layui.laydate;
			var table = layui.table;
			
			laydate.render({
				elem:"#laydate1"
			})

			table.render({
				elem: '#table',
				url: 'http://localhost:8088/book/books/',
				where:{status:0},
				cols: [
					[{
						title: "序号",
						type: "numbers",
						align: "center"
					}, {
						field: "name",
						title: "书名"
					}, {
						field: "author",
						title: "作者",
						align: "center"
					}, {
						field: "type",
						title: "类别",
						align: "center",
						templet: d => {
							for (var i = 0; i < vue.types.length; i++) {
								if (d.type == vue.types[i].id) {
									return vue.types[i].typeName
								}
							}
							return "未知"
						}
					}, {
						field: "press",
						title: "出版社",
						align: "center",
						templet: d => {
							for (var i = 0; i < vue.list.length; i++) {
								if (d.press == vue.list[i].id) {
									return vue.list[i].name
								}
							}
							return "未知"
						}
					}, {
						field: "pushTime",
						title: "出版时间",
						align: "center"
					}, {
						field: "count",
						title: "剩余数量",
						align: "center"
					}, {
						title: "操作",
						align: "center",
						toolbar: "#btns"
					}]
				],
				page: !0,
				limit: 10,
				limits: [10, 20, 30],
				text: {
					none: '暂无相关数据' //默认：无数据
				}
			});
			
			table.on('tool(table)', function(obj) {
				var data = obj.data;
				var layEvent = obj.event;
				var tr = obj.tr;
				if (layEvent == 'xq') {
					layer.open({
						type: 2,
						title: '详情',
						content: 'book-details.html?id=' + data.id + "&userid=" + par.userid,
						maxmin: true,
						area: ['100%', '100%']
					});
				}else if (layEvent == 'js') {
					if(data.count==0){
						layer.alert("该书没有剩余，不可借！",{icon:2})
						return false;
					}
					layer.confirm('确认借一本:<br/>《'+data.name+'》', {
						btn: ['确认', '取消'] //按钮
					}, function(){
						$.post("http://localhost:8088/book/borrow/",{
							userId : par.userid,
							bookId : data.id
						},function (res){
							layer.closeAll()
							layer.msg("已借一本"+'《'+data.name+'》')
							table.reload('table')
						})
					});
				}
			});
			//双击
			table.on('rowDouble(table)', function(obj) {
				var data = obj.data;
				layer.open({
					type: 2,
					title: '详情',
					content:  "book-details.html?id=" + data.id + "&userid=" + par.userid,
					maxmin: true,
					area: ['100%', '100%']
				});
			});

			//搜索
			form.on('submit(search)', function(obj) {
				let field = obj.field
				table.reload('table',{
					where:field
				})
			});
		});
	</script>
</html>
