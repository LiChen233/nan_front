<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8">
		<title>图书管理</title>
		<link rel="stylesheet" href="../../layuiadmin/layui/css/layui.css" media="all">
		<script src="../../layuiadmin/js/jquery.min.js" type="text/javascript" charset="utf-8"></script>
		<script src="../../layuiadmin/js/getCookie.js" type="text/javascript" charset="utf-8"></script>
		<script type="text/javascript">
			var list = [];
			$.get("http://localhost:8088/book/press/", function(res) {
				list = res.data
			})
		</script>
	</head>
	<body>
		<div class="layui-fluid">
			<div class="layui-card" style="padding: 10px 20px 20px 20px;margin-top: 20px;">
				<div class="layui-form" style="margin-top: 30px;">
					<div class="layui-form-item">
						<div class="layui-input-inline" style="width: 400px;">
							<input type="text" name="search" lay-verify="title" autocomplete="off" placeholder="请输入：合同名称、合同编号、发起人名称进行搜索"
							 class="layui-input">
						</div>
						<div class="layui-inline">
							<div class="layui-input-inline">
								<input name="createdate" type="text" autocomplete="off" class="layui-input" id="laydate1" placeholder="合同接受日期">
							</div>
						</div>
						<div class="layui-inline">
							<div class="layui-input-inline">
								<input name="enddate" type="text" autocomplete="off" class="layui-input" id="laydate2" placeholder="合同截止日期">
							</div>
						</div>
						<div class="layui-inline">
							<button class="layui-btn" lay-submit lay-filter="search">
								<i class="layui-icon layui-icon-search"></i>合同检索
							</button>
						</div>
					</div>
					<div class="layui-form-item">
						<table class="layui-table" id="table" lay-filter="table"></table>
						<script type="text/html" id="btns">
							<div class="layui-btn layui-btn-xs" lay-event="bj">
								编辑
							</div>
							{{#if(d.status=='0'){}}
								<div class="layui-btn layui-btn-xs layui-btn-warm" lay-event="xj">
									下架
								</div>
							{{#}else if(d.status=='1'){}}
								<div class="layui-btn layui-btn-xs layui-btn-normal" lay-event="sj">
									上架
								</div>
							{{#}}}
						</script>
					</div>
				</div>
			</div>
		</div>
	</body>
	<script src="../../layuiadmin/layui/layui.js"></script>
	<script>
		layui.use(['laydate', 'form', 'table'], function() {
			var form = layui.form;
			var laydate = layui.laydate;
			var table = layui.table;

			table.render({
				elem: '#table',
				url: 'http://localhost:8088/book/books/',
				cols: [
					[{
						title: "序号",
						type: "numbers",
						align: "center"
					}, {
						field: "name",
						title: "书名"
					}, {
						field: "author",
						title: "作者",
						align: "center"
					}, {
						field: "press",
						title: "出版社",
						align: "center",
						templet: d => {
							for (var i = 0; i < list.length; i++) {
								if (d.press == list[i].id) {
									return list[i].name
								}
							}
							return "未知"
						}
					}, {
						field: "pushTime",
						title: "出版时间",
						align: "center"
					}, {
						field: "count",
						title: "剩余数量",
						align: "center"
					}, {
						title: "操作",
						align: "center",
						toolbar: "#btns"
					}]
				],
				page: !0,
				limit: 10,
				limits: [10, 20, 30],
				text: {
					none: '暂无相关数据' //默认：无数据
				}
			});
			
			function jj(data,status){
				$.post("http://localhost:8088/book/books/",{
					_method:"PUT",
					id:data.id,
					status:status
				},function(res){
					if(res.code==0){
						layer.msg("成功");
						table.reload('table')
					}else{
						layer.alert("失败！");
						table.reload('table')
					}
				})
			}

			table.on('tool(table)', function(obj) {
				var data = obj.data;
				var layEvent = obj.event;
				var tr = obj.tr;
				if (layEvent == 'bj') {
					layer.open({
						type: 2,
						title: '编辑',
						content: 'book-add.html?id=' + data.id,
						maxmin: true,
						area: ['100%', '100%'],
						btn: ['提交', '取消'],
						yes: function(index, layero) {
							//点击确认触发 iframe 内容中的按钮提交
							var submit = layero.find('iframe').contents().find("#case-submit");
							submit.click();
						}
					});
				}else if (layEvent == 'xj') {
					layer.confirm('确认要下架该书吗？<br/>下架后可重新上架', {
						btn: ['确认', '取消'] //按钮
					}, function(){
						jj(data,"1")
					});
				}else if (layEvent == 'sj') {
					layer.confirm('确认要上架该书吗？', {
						btn: ['确认', '取消'] //按钮
					}, function(){
						jj(data,"0")
					});
				}
			});
			//双击
			table.on('rowDouble(table)', function(obj) {
				var data = obj.data;
				$("#caseform").attr("lay-href", "case/case-form.html?id=" + data.id + "&userid=" + userid);
				$("#caseform").click();
			});

			//提交
			form.on('submit(search)', function(obj) {

			});
		});
	</script>
</html>
