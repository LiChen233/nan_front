<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8">
		<title>书籍详情</title>
		<link rel="stylesheet" href="../../layuiadmin/layui/css/layui.css" media="all">
		<script src="../../layuiadmin/js/jquery.min.js" type="text/javascript" charset="utf-8"></script>
		<script src="../../layuiadmin/js/getCookie.js" type="text/javascript" charset="utf-8"></script>
		<script src="../../layuiadmin/js/vue.min.js" type="text/javascript" charset="utf-8"></script>
		<script src="../../layuiadmin/js/Tools.js" type="text/javascript" charset="utf-8"></script>
		<style type="text/css">
			#demo1 {
				width: 260px;
				height: 360px;
			}
		</style>
	</head>
	<body>
		<div class="layui-fluid">
			<div class="layui-card" style="padding: 10px 20px 20px 20px;margin-top: 20px;">
				<div class="layui-form layui-row" style="margin-top: 30px;">
					<fieldset class="layui-elem-field layui-field-title">
						<legend>书籍详情</legend>
					</fieldset>
					<div class="layui-form-item">
						<div class="layui-inline layui-col-xs2" style="margin-left: 120px;">
							<img :src="url+fileid" class="layui-upload-img" id="demo1">
						</div>
						<div class="layui-inline layui-col-xs8">
							<table class="layui-table">
								<colgroup>
									<col width="300">
									<col width="300">
									<col width="300">
								</colgroup>
								<tbody>
									<tr>
										<td>书名：{{obj.name}}</td>
										<td>作者：{{obj.author}}</td>
										<td>ISBN：{{obj.isbn}}</td>
									</tr>
									<tr>
										<td>出版社{{obj.press}}</td>
										<td>出版时间：{{obj.push_time}}</td>
										<td>打印时间：{{obj.print_time}}</td>

									</tr>
									<tr>
										<td>版次：{{obj.edition}}</td>
										<td>印次：{{obj.print}}</td>
										<td>规格：{{obj.specs}}</td>
									</tr>
									<tr>
										<td>剩余数量：{{obj.count}}</td>
										<td>单价：{{obj.price}}</td>
										<td>类型：{{obj.type}}</td>
									</tr>
									<tr>
										<td colspan="3">
											总评分：<div id="star" style="margin-top: 7px;"></div>{{obj.star!=null?obj.star:"暂无评"}}分
										</td>
									</tr>
									<tr>
										<td colspan="3">说明：{{obj.details}}</td>
									</tr>
								</tbody>
							</table>
						</div>
					</div>
					<div class="layui-form-item" style="text-align: right;">
						<div class="layui-btn" style="margin-right: 200px;" id="borrow">
							我要借书
						</div>
					</div>
					<fieldset class="layui-elem-field layui-field-title" style="margin-top: 50px;">
						<legend>评论内容</legend>
					</fieldset>
					<div class="layui-form-item " style="margin-left: 50px;">
						<div class="layui-form-item layui-form-text layui-col-xs9">
							<label class="layui-form-label">评论：</label>
							<div class="layui-input-block">
								<textarea name="remark" required lay-verify="required" placeholder="请输入内容" class="layui-textarea"></textarea>
							</div>
						</div>
						<div class="layui-inline layui-col-xs2" style="margin-left: 30px;">
							<div id="test4"></div>
						</div>
						<div class="layui-inline layui-col-xs2" style="margin-left: 30px;">
							<div class="layui-btn layui-btn-normal" lay-submit="" lay-filter="add" id="add">
								提交评论
							</div>
						</div>
					</div>
					<template v-for="item,i in star">
						<hr v-if="i!=0">
						<div class="layui-form-item" style="margin:30px 0px 30px 50px;">
							<div class="layui-col-xs1" style="text-align: right;font-weight: bold;line-height: 35px;">
								{{item.nickName}}:
							</div>
							<div class="layui-col-xs8" style="margin: 0 10px;text-indent: 1em;margin-top: 8px;">
								{{item.remark}}
							</div>
							<div class="layui-col-xs1" style="text-align: left;color: gray;">
								{{item.upTime}}<br />评分<span style="color: orange;">{{item.star}}</span>
							</div>
						</div>
					</template>
				</div>
			</div>
		</div>
	</body>
	<script src="../../layuiadmin/layui/layui.js"></script>
	<script>
		var vue = new Vue({
			el: ".layui-fluid",
			data: {
				obj: [],
				list: [],
				types: [],
				form: null,
				fileid: "",
				url: '',
				rate:null,
				star:[],
				rate:null
			},
			created: function() {
				$.get("http://localhost:8088/book/press/", function(res) {
					vue.list = res.data
				})
				$.get("http://localhost:8088/book/types/", function(res) {
					vue.types = res.data
				})
				//获取url
				$.get("http://localhost:8088/book/getServerUrl", function(res) {
					vue.url = res
					console.log(res)
				});
				//回显
				$.get("http://localhost:8088/book/books/?id=" + par.id, function(res) {
					vue.obj = res.data[0]
					vue.fileid = res.data[0].cover
				})
				//获取评论
				$.get("http://localhost:8088/book/star/?bookId="+par.id,function(res){
					vue.star = res.data
				})
			},
			updated: function() {
				if (vue.form != null) {
					vue.form.render()
				}
				if(vue.rate!=null){
					vue.rate.render()
				}
			}
		})
		layui.use(['form', 'rate'], function() {
			var form = layui.form
			vue.form = form
			var rate = layui.rate;
			vue.rate = rate

			rate.render({
				elem: '#test4',
				half: true,
				text: true,
				choose: function(value) {
					vue.rate = value
				}
			})
			
			rate.render({
				elem: '#star',
				half: true,
				value: vue.obj.star,
				readonly:true
			})
			
			$("li").attr("class","layui-inline")
			
			$("#borrow").click(function(){
				if(vue.obj.count==0){
					layer.alert("该书没有剩余，不可借！",{icon:2})
					return false;
				}
				layer.confirm('确认借一本:<br/>《'+vue.obj.name+'》', {
					btn: ['确认', '取消'] //按钮
				}, function(){
					$.post("http://localhost:8088/book/borrow/",{
						userId : par.userid,
						bookId : vue.obj.id
					},function (res){
						layer.closeAll()
						layer.msg("已借一本"+'《'+vue.obj.name+'》')
						var index=parent.layer.getFrameIndex(window.name); //获取当前窗口的name
						setTimeout(function(){
							parent.layer.close(index);		//关闭窗口
						},1000)
					})
				});
			})

			//提交
			form.on('submit(add)', function(obj) {
				if(vue.rate == null){
					layer.alert("请评分！",{icon:2})
				}
				var field = obj.field
				field.star = vue.rate
				field.userId = par.userid
				field.bookId = par.id
				$.post("http://localhost:8088/book/star/",field,function(res){
					if(res.code==0){
						layer.msg("评论成功")
						$(location).attr('href', "book-details.html?id=" + par.id + "&userid=" + par.userid);
					}else{
						layer.msg("评论失败！")
					}
				})
			});
		});
	</script>
</html>
